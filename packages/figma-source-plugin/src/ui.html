<img src="./logo.png" width="300" height="140"/>

<button id="copy">Copy to clipboard</button>
<button id="hidden" hidden=true data-clipboard-text="">HIDDEN</button>
<br />
<p>Selection count: <b id="count">init</b></p>
<code id="text">init</code>

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  // const eventListeners: { type: String; callback: Function }[] = [];
  // export const dispatch = (action: String, data?: any) => {
  // 	parent.postMessage({ pluginMessage: { action, data } }, '*');
  // };
  // export const handleEvent = (type: String, callback: Function) => {
  // 	eventListeners.push({ type, callback });
  // };
  // window.onmessage = event => {
  // 	const message = event.data.pluginMessage;
  // 	if (message) {
  // 		for (let eventListener of eventListeners) {
  // 	 	if (message.action === eventListener.type) eventListener.callback(message.data);
  // 		}
  // 	}
  // };
  function sleep(ms) { return new Promise((resolve) => { setTimeout(() => { resolve() }, ms) }) }


  const clipboard = new ClipboardJS('#hidden')
  // console.info('CLIPBOARD', clipboard) // TODO
  clipboard.on('success', async (e) => {
    console.info('CLIPBOARD SUCCESS', e) // TODO
    await sleep(100) // need to sleep a while to make sure the clipboard is updated before closing
    parent.postMessage({ pluginMessage: { action: 'CLOSE', data: 'Copy was successful, paste into Squid' } }, '*')
  })
  clipboard.on('error', async (e) => {
    console.info('CLIPBOARD ERROR', e) // TODO
    parent.postMessage({ pluginMessage: { action: 'CLOSE', data: 'Copy was unsuccessful' } }, '*')
  })



  const copyElem = document.getElementById('copy')
  copyElem.onclick = async () => {
    copyElem.innerText = 'Copying...'
    copyElem.setAttribute('disabled', true)
    await sleep(20) // need to sleep a while to update the copy button
    parent.postMessage({ pluginMessage: { action: 'COPY_PRESSED' } }, '*')
  }

  // window.onfocus = () => { console.info('ON FOCUS') }
  // window.onblur = () => { console.info('ON BLUR') }
  // window.onfocus = () => dispatch("windowFocus", true);
  // window.onblur = () => dispatch("windowFocus", false);

  onmessage = async (event) => {
    const message = event.data.pluginMessage
    console.info('MESSAGE', message.action, message)

    if (message.action === 'SELECTION_CHANGE') {
      const source = message.data
      const selectionLength = source?.context?.selectedContent?.length ?? 0
      const selectionNames = selectionLength > 0 ? source?.context?.selectedContent?.map(c => c.name).join(`\n`) : ''
      
      const countElem = document.getElementById('count')
      countElem.innerText = selectionLength

      const textElem = document.getElementById('text')
      textElem.innerText = selectionNames
    }

    if (message.action === 'COPY_RESPONSE') {
      const source = message.data

      const hiddenElem = document.getElementById('hidden')
      // hiddenElem.setAttribute('data-clipboard-text', JSON.stringify(source))
      hiddenElem.setAttribute('data-clipboard-text', source)

      // await sleep(500)
      // console.info('XXX hiddenElem length', hiddenElem.getAttribute('data-clipboard-text').length)
      hiddenElem.click()
    }
  }
</script>
